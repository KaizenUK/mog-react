---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Find the right oil">
  <main class="mx-auto max-w-4xl px-4 py-10">
    <header class="mb-8">
      <h1 class="text-3xl font-semibold">Find the right oil</h1>
      <p class="mt-3 text-base opacity-80">
        Enter your vehicle registration to check basic vehicle details. Recommendations come next.
      </p>
    </header>

    <form id="vrm-form" class="grid gap-3 max-w-md">
      <label class="text-sm font-medium" for="vrm">Vehicle registration</label>

      <div class="flex gap-2">
        <input
          id="vrm"
          name="vrm"
          autocomplete="off"
          inputmode="text"
          placeholder="e.g. TE57VRN"
          class="flex-1 rounded-xl border px-4 py-3"
          required
        />
        <button
          id="vrm-submit"
          class="rounded-xl border px-4 py-3 font-medium hover:opacity-80 disabled:opacity-60"
          type="submit"
        >
          Check
        </button>
      </div>

      <p id="vrm-error" class="text-sm text-red-600 hidden"></p>

      <div id="vrm-result" class="hidden rounded-2xl border p-4">
        <p class="text-sm opacity-80">Vehicle found</p>
        <p class="mt-1 text-base font-semibold" id="vrm-title"></p>

        <dl class="mt-3 grid gap-2 text-sm sm:grid-cols-2">
          <div>
            <dt class="opacity-70">Fuel</dt>
            <dd id="vrm-fuel"></dd>
          </div>
          <div>
            <dt class="opacity-70">Year</dt>
            <dd id="vrm-year"></dd>
          </div>
          <div>
            <dt class="opacity-70">Engine</dt>
            <dd id="vrm-engine"></dd>
          </div>
          <div>
            <dt class="opacity-70">Colour</dt>
            <dd id="vrm-colour"></dd>
          </div>
        </dl>
      </div>
    </form>
  </main>

  <script type="module">
    const form = document.getElementById("vrm-form");
    const input = document.getElementById("vrm");
    const submit = document.getElementById("vrm-submit");

    const err = document.getElementById("vrm-error");
    const box = document.getElementById("vrm-result");

    const title = document.getElementById("vrm-title");
    const fuel = document.getElementById("vrm-fuel");
    const year = document.getElementById("vrm-year");
    const engine = document.getElementById("vrm-engine");
    const colour = document.getElementById("vrm-colour");

    function showError(message) {
      err.textContent = message;
      err.classList.remove("hidden");
      box.classList.add("hidden");
    }

    function clearError() {
      err.textContent = "";
      err.classList.add("hidden");
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearError();

      const raw = String(input.value || "");
      const vrm = raw.toUpperCase().replace(/[^A-Z0-9]/g, "");

      if (!vrm) {
        showError("Enter a registration number.");
        return;
      }

      submit.setAttribute("disabled", "true");

      try {
        const res = await fetch("/api/vrm-lookup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ registrationNumber: vrm }),
        });

        const data = await res.json();

        if (!data.ok) {
          const msg = [data.error, data.help, data.action].filter(Boolean).join(" ");
          showError(msg || "Lookup is unavailable on this static preview. Please contact us for help.");
          return;
        }

        const v = data.vehicle || {};
        title.textContent = [v.make, v.registrationNumber].filter(Boolean).join(" • ");
        fuel.textContent = v.fuelType || "—";
        year.textContent = v.yearOfManufacture ? String(v.yearOfManufacture) : "—";
        engine.textContent = v.engineCapacity ? `${v.engineCapacity} cc` : "—";
        colour.textContent = v.colour || "—";

        box.classList.remove("hidden");
      } catch {
        showError("Lookup is unavailable on this static preview. Please contact us for help.");
      } finally {
        submit.removeAttribute("disabled");
      }
    });
  </script>
</Layout>
