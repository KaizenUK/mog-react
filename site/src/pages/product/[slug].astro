---
import Layout from "../../layouts/Layout.astro";
import { getAllProductSlugs, getProductBySlug, type PackSize } from "../../lib/sanity/products";
import { portableTextToHtml } from "../../lib/portableTextToHtml.ts";
import { urlForImage } from "../../lib/sanity/image.ts";
import ProductDetail, { type PackSizeResolved, type TechDoc } from "../../components/ProductDetail.tsx";

export async function getStaticPaths() {
  const slugs = await getAllProductSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
if (!slug) return Astro.redirect("/products", 302);

const product = await getProductBySlug(slug);
if (!product) return Astro.redirect("/products", 302);

function safeText(v: unknown): string {
  if (!v) return "";
  return String(v);
}

// ── Docs ─────────────────────────────────────────────────────────────────────

const docsA = product.productTechnicalDocuments ?? [];
const docsB = product.linkedTechnicalDocuments ?? [];

const seen = new Set<string>();
const uniqueDocs: TechDoc[] = [...docsA, ...docsB]
  .map((d) => ({
    title: safeText(d.title),
    docType: d.docType ? safeText(d.docType).toUpperCase() : "",
    language: d.language ? safeText(d.language).toUpperCase() : "",
    url: d.url ?? "",
  }))
  .filter((d) => {
    if (!d.url || seen.has(d.url)) return false;
    seen.add(d.url);
    return true;
  });

// ── Images ────────────────────────────────────────────────────────────────────

const mainImageUrl = product?.mainImage
  ? urlForImage(product.mainImage).width(900).quality(90).url()
  : undefined;

const resolvedPackSizes: PackSizeResolved[] = (product.packSizes ?? []).map((ps: PackSize) => ({
  label: safeText(ps.label),
  sku:      ps.sku      ? safeText(ps.sku)      : undefined,
  imageUrl: ps.image    ? urlForImage(ps.image).width(900).quality(90).url() : undefined,
  price:    ps.price    ? safeText(ps.price)    : undefined,
  leadTime: ps.leadTime ? safeText(ps.leadTime) : undefined,
  moq:      ps.moq      ? safeText(ps.moq)      : undefined,
  notes:    ps.notes    ? safeText(ps.notes)    : undefined,
}));

// ── Body HTML (passed into React island to display next to the image) ─────────

const bodyHtml = product?.body?.length ? portableTextToHtml(product.body) : "";

// ── SEO ───────────────────────────────────────────────────────────────────────

const seoTitle       = product?.seo?.title ?? `${product.title} | Midland Oil Group`;
const seoDescription = product?.seo?.description ?? product.summary ?? undefined;
const seoNoIndex     = product?.seo?.noIndex ?? false;
const seoCanonical   =
  product?.seo?.canonicalUrl ??
  (Astro.site ? new URL(Astro.url.pathname, Astro.site).toString() : undefined);
---

<Layout
  title={seoTitle}
  description={seoDescription}
  canonicalUrl={seoCanonical}
  noIndex={seoNoIndex}
>
  <!-- Product page uses above-main slot for full-width layout control -->
  <div slot="above-main">
    <ProductDetail
      client:load
      title={product.title}
      slug={product.slug}
      summary={product.summary}
      bodyHtml={bodyHtml}
      mainImageUrl={mainImageUrl}
      viscosityGrade={product.viscosityGrade}
      approvals={product.approvals ?? []}
      packSizes={resolvedPackSizes}
      unavailablePackSizes={product.unavailablePackSizes ?? []}
      docs={uniqueDocs}
    />
  </div>
</Layout>
